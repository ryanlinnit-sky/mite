version: 2.1

orbs:
  python: circleci/python@2.0.3
  jq: circleci/jq@2.2.0

# Further ideas for jobs to run:
# - license check
# - make sure test coverage increases
# And, once we're sure that the pipeline is working:
# - integration/performance tests
# Once we have docs:
# - documentation coverage
# - docs build (on master only)


workflows:
  mite:
    jobs:
      - build-and-test
      - tag:
          requires:
            - build-and-test
          filters:
            branches:
              only: master
      - linux-wheels:
          requires:
            - tag
          filters:
            branches:
              only: master
      - osx-wheels:
          requires:
            - tag
          filters:
            branches:
              only: master


jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
      - python/install-packages:
          pip-dependency-file: test-requirements.txt
          pkg-manager: pip
      - python/install-packages:
          pip-dependency-file: dev-requirements.txt
          pkg-manager: pip
      - run:
          name: pre-commit checks
          command: pre-commit run --origin HEAD --source origin/master || git diff
      - run:
          name: tox
          command: tox -e py310

  tag:
    docker:
      - image: cimg/python:3.10
    steps:
      - add_ssh_keys:
          fingerprints:
            - "fc:39:a2:b8:32:23:52:a5:fe:45:b6:9b:12:e7:30:2a"
      - checkout
      - run:
          name: tag github version
          command: bash cd-scripts/cdRelease.sh -v patch

  linux-wheels:
    # we only need to build the 'mite' wheels on one platform
    # so we only need to run `python3 -m build` in this job
    working_directory: ~/linux-wheels
    docker:
      - image: cimg/python:3.10
    environment:
      CIBW_BEFORE_ALL_LINUX: "yum install -y libcurl-devel || apt-get install -y libcurl-dev || apk add curl-dev"
      CIBW_SKIP: "*i686"
    steps:
      - checkout
      - jq/install
      - setup_remote_docker
      - run:
          name: Build the Linux wheels.
          command: |
            pip3 install --user cibuildwheel==2.8.1 build Cython twine
            python3 -m build --outdir ./wheelhouse
            if [[ -n $(git show --name-only ${CIRCLE_SHA1} ./acurl) ]]; then
              LATEST_ACURL_VERSION=$(curl https://pypi.org/pypi/acurl/json | jq '.info .version')

              if [[ -n $(grep "version = $LATEST_ACURL_VERSION" acurl/setup.cfg) ]]; then
                echo "Version of acurl hasn't changed"
                exit 1
              fi

              cd acurl
              python3 -m build --sdist --outdir ../wheelhouse
              cibuildwheel --output-dir ../wheelhouse
            fi
      - run:
          name: init .pypirc
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = __token__" >> ~/.pypirc
            echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
      - run:
          name: upload packages to pypi
          command: twine upload wheelhouse/*
      - store_artifacts:
          path: wheelhouse/

  osx-wheels:
    working_directory: ~/osx-wheels
    macos:
      xcode: 12.5.1
      # I don't know what version to go with
      # https://circleci.com/docs/testing-ios#supported-xcode-versions
      # 14.0.0 is the latest, go with that? Which is the most compatible?..
      # I hate apple 🍏
    steps:
      - checkout
      - jq/install
      - run:
          name: Build the OS X wheels.
          command: |
            pip3 install cibuildwheel==2.8.1 Cython twine
            if [[ -n $(git show --name-only ${CIRCLE_SHA1} ./acurl) ]]; then
              LATEST_ACURL_VERSION=$(curl https://pypi.org/pypi/acurl/json | jq '.info .version')

              if [[ -n $(grep "version = $LATEST_ACURL_VERSION" acurl/setup.cfg) ]]; then
                echo "Version of acurl hasn't changed"
                exit 1
              fi

              cd acurl
              cibuildwheel --output-dir ../wheelhouse --archs x86_64,arm64
            fi
      - run:
          name: init .pypirc
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = __token__" >> ~/.pypirc
            echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
      - run:
          name: upload packages to pypi
          command: twine upload wheelhouse/*
      - store_artifacts:
          path: wheelhouse/
